# Термо детектор лжи (MVP)

Настольное приложение PySide6 для записи тепловидео и аудио, логирования вопросов/ответов и разметки итогов "Правда/Ложь". Реализовано с плагинными адаптерами тепловизоров (Dummy/File/Vendor skeleton), базовой моделью определения и экспортом в Excel.

## Возможности
- Экран выбора пользователя с профилями (ФИО), создание пользователя и опциональная запись голосового отпечатка.
- Главный экран сессии: выбор тепловизора и микрофона, предпросмотр, контроль уровня, добавление вопросов, управление записью, кнопки разметки сегментов, мини-лог.
- Индикатор во время записи показывает только слово «Правда» или «Ложь» (гистерезис по score). Внутренние score сохраняются в JSON/SQLite, но не выводятся в индикаторе.
- Таймлайн меток, сохранение `thermal_view.mp4`, `audio.wav`, `timeline.json`, `qa.xlsx`, `session.sqlite`, `diagnostics.log` (лог пишется в консоль/файл `diagnostics.log`).
- Экран "Разбор" с таблицей Q/A, экспортом в Excel и быстрым открытием папки сессии.
- DummyThermalAdapter использует вебкамеру и псевдо-тепловую палитру, FileThermalAdapter читает из `sample/sample.mp4`, VendorThermalAdapter — каркас для SDK.

## Установка окружения (conda, Python 3.11)
```bash
conda create -n thermodeception python=3.11
conda activate thermodeception
pip install -r requirements.txt
# убедитесь, что установлен ffmpeg (например, через conda-forge: conda install -c conda-forge ffmpeg)
```

## Запуск
```bash
python main.py
```
При первом запуске создастся файл конфигурации и БД в `~/.thermodeception/`. Для FileThermalAdapter положите тестовое видео в `sample/sample.mp4` (или замените путь в коде при необходимости).

## Сборка (PyInstaller one-folder)
```bash
pip install pyinstaller
pyinstaller --noconfirm --clean --name thermodeception --onefile --windowed main.py
# либо сборка one-folder
pyinstaller --noconfirm --clean --name thermodeception --windowed main.py
```
Убедитесь, что `ffmpeg` доступен в PATH. На Windows добавьте его в PATH или положите рядом с исполняемым файлом.

## Структура проекта
- `app/services/thermal_adapters.py` — плагинные адаптеры тепловизора (Dummy/File/Vendor).
- `app/services/deception.py` — базовая модель с извлечением признаков и гистерезисом «Правда/Ложь».
- `app/services/audio.py` — запись аудио, индикатор уровня, сервис голосового отпечатка.
- `app/ui/session_window.py` — главный экран сессии и управление записью.
- `app/ui/user_selection.py` — выбор/создание пользователя.
- `app/ui/review_window.py` — экран разбора, экспорт в Excel.
- `app/utils/*` — таймлайн, экспорт QA.
- `sample/` — положите тестовое видео `sample.mp4` для FileThermalAdapter.

## Мини-инструкция внутри приложения
В меню «Справка» добавьте пункт «Инструкция» (отображается в стартовом окне PySide6) или используйте пункты:
1. Выберите пользователя или создайте нового (ФИО обязательно, голосовой мастер — опционально).
2. На главном экране выберите тепловизор (Dummy вебкамера или файл), микрофон и папку сохранения.
3. Добавьте вопросы в таблицу или фиксируйте по ходу. Нажмите «Начать запись» — появится красный REC и индикатор «Правда/Ложь».
4. Во время записи используйте кнопки «Следующий вопрос», «Конец ответа», «Метка события» для таймкодов.
5. После «Закончить запись» откроется окно «Разбор», где можно скорректировать текст Q/A, экспортировать в Excel и открыть папку сессии.

## Заметки по расширению
- Для интеграции реального тепловизора реализуйте VendorThermalAdapter с вызовами SDK.
- Базовая модель легко заменяется на ONNX: загрузите веса в `DeceptionService.infer` вместо логистической регрессии.
- Для улучшения ASR подключите `faster-whisper` и VAD (webrtcvad) в потоках.
